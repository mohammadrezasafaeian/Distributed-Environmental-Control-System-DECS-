
<div dir="rtl">

# سیستم کنترل و اتوماسیون توزیع‌شده (DECS)
*پلتفرم اتوماسیون توزیع‌شده: مغز STM32 که نودهای میدانی مقیاس‌پذیر AVR را از طریق I2C کنترل می‌کند، به همراه داشبورد وب ESP32.*

## معرفی پروژه
یک سیستم Embedded توزیع‌شده که برای اتوماسیون محیطی مقیاس‌پذیر طراحی شده است. اگرچه این سیستم در اینجا به عنوان یک **گلخانه هوشمند** نمایش داده شده است، اما معماری زیرساختی Master-Slave آن به‌گونه‌ای طراحی شده که مستقل از کاربرد (Application-Agnostic) باشد و بتوان با کمترین تغییرات در فریمور، آن را برای سناریوهایی مانند **مانیتورینگ اتاق سرور یا لجستیک سردخانه** تغییر کاربری داد.

- **کنترل چند منطقه‌ای (Multi-Zone)**: مدیریت مستقل سنسورها (دما، رطوبت، نور) و عملگرها (پمپ، فن، نور، رطوبت‌ساز) در چندین نود مختلف.
- **باس مقیاس‌پذیر**: پشتیبانی نظری از ۱۱۲ منطقه مستقل تنها با استفاده از یک باس I2C دو سیمه.
- **طراحی مقاوم**: دارای کنترل هیسترزیس (Hysteresis)، مکانیزم‌های بازیابی باس I2C و محافظت Watchdog.
- **رابط کاربری دوگانه (Dual HMI)**: رابط محلی (OLED + Keypad) برای تعمیر و نگهداری میدانی، و داشبورد وب (ESP32) برای مانیتورینگ از راه دور.

---

## تاریخچه و تکامل پروژه
این پروژه در سال ۲۰۲۰ به عنوان یک کنترلر ساده و یکپارچه (Monolithic) مبتنی بر AVR شروع شد.
> [👉 **مشاهده کد اولیه و قدیمی (نسخه ۲۰۲۰)**](legacy_2020_v0/)
> برای دیدن روند تکامل معماری از یک پروژه مقدماتی تک-تراشه‌ای به سیستم توزیع‌شده و حرفه‌ای امروزی.

---

## معماری سیستم
</div>

```text
┌─────────────────────────────────────────────────────────┐
│                    STM32F4 Master                       │
│  - Profile database & control logic                     │
│  - I2C master (polls zone controllers)                  │
│  - OLED/Keypad UI                                       │
│  - UART → ESP32                                         │
└───────────┬──────────────┬──────────────┬───────────────┘
            │ I2C          │ I2C          │ UART
    ┌───────▼──────┐  ┌────▼──────┐  ┌───▼──────────┐
    │  ATmega32    │  │ ATmega32  │  │   ESP32      │
    │  Zone 1      │  │  Zone 2   │  │  WiFi AP     │
    │ (0x08)       │  │  (0x07)   │  │  Dashboard   │
    │              │  │           │  │  Port 80     │
    │ 3× Sensors   │  │ 3× Sensors│  └──────────────┘
    │ 4× Actuators │  │ 4× Actuators│
    └──────────────┘  └────────────┘
```
<div dir="rtl">


---
### تصمیمات کلیدی طراحی
۱. **مقیاس‌پذیری ۲ سیمه (I2C)**: با استفاده از AVRها به عنوان نودهای آدرس‌پذیر I2C، کل تاسیسات تنها به **دو سیم اشتراکی داده** برای کنترل +۱۰۰ (بالقوه و روی کاغذ) منطقه مجزا نیاز دارد و از طریق تنها یک چیپ اصلی، که هزینه تمام شده و پیچیدگی کابل‌کشی را نسبت به سیستم‌های توپولوژی ستاره (سیم‌کشی مجزا) به شدت کاهش می‌دهد.

۲. **ایزولاسیون ولتاژ/نویز**: نودهای میدانی، سوئیچینگ رله‌های ۵ ولتی و نویز سنسورها را به صورت محلی مدیریت می‌کنند و Master حساس ۳.۳ ولتی را از تداخلات محیط‌های صنعتی محافظت می‌کنند.

۳. **منطق متمرکز**: تمام داده‌های پروفایل و الگوریتم‌های تصمیم‌گیری فقط در Master قرار دارند؛ بنابراین نودهای میدانی هنگام تعویض به هیچ تنظیماتی نیاز ندارند.

---

## پروتکل‌های ارتباطی
| باس | جهت | فرمت | نرخ |
|---|---|---|---|
| **I2C** | STM32 → ATmega32 | دستورات (0x10-0x17) | 500ms |
| **I2C** | ATmega32 → STM32 | ۶ بایت (۳ مقدار ۱۶ بیتی ADC) | 500ms |
| **UART** | STM32 → ESP32 | وضعیت JSON | 1000ms |
| **I2C** | STM32 → SSD1306 | به‌روزرسانی نمایشگر | 250ms |

---

## پایگاه داده پروفایل گیاهان
در حال حاضر ۷ پروفایل پشتیبانی می‌شود (قابل توسعه آسان در `plant_profiles.c`):
| پروفایل | رطوبت | دما | نور | فاصله آبیاری | مدت آبیاری |
|---|---|---|---|---|---|
| گوجه | 450 | 280 | 650 | ۳۰ثانیه | ۵ثانیه |
| کاهو | 500 | 200 | 400 | ۲۰ثانیه | ۳ثانیه |
| خیار | 490 | 270 | 620 | ۳۵ثانیه | ۶ثانیه |
| *(+4 مورد دیگر)* | | | | | |

**افزودن پروفایل**: کافیست به آرایه `profiles[]` اضافه کنید!

---

## قابلیت‌ها
### کنترلر مرکزی STM32 (STM32F411)
- ✅ سیستم منو با اسکرول (پشتیبانی از ۴+ پروفایل در هر صفحه)
- ✅ حالت کنترل دستی (کنترل مستقیم عملگرها)
- ✅ کنترل خودکار با هیسترزیس
- ✅ بازیابی باس I2C (مدیریت Slaveهای گیر کرده)
- ✅ تشخیص تخریب حافظه (Stack Canary)

### کنترلر منطقه (ATmega32 @ 8MHz)
- ✅ ۳ خواندن ADC ده-بیتی (رطوبت/دما/نور)
- ✅ ۴ عملگر GPIO (پمپ/رطوبت‌ساز/فن/نور)
- ✅ حالت I2C Slave با پردازش دستورات
- ✅ نمونه‌برداری بیشتر (Oversampling - ۱۰۰ نمونه در هر خواندن)

### داشبورد وب ESP32
- ✅ نمودارهای Real-time سنسورها (Chart.js)
- ✅ نشانگرهای وضعیت زنده عملگرها
- ✅ نقشه حرارتی (Heatmap) آبیاری ۲۴ ساعته
- ✅ لاگ رویدادها (Timeline)
- ✅ طراحی ریسپانسیو (Responsive)
- ✅ حالت اکسس پوینت (192.168.4.1)

### معماری مقیاس‌پذیر
سیستم از یک **باس I2C اشتراکی** برای کنترل تعداد نامحدودی از مناطق کنترلی تنها با **۲ سیم** استفاده می‌کند:
</div>

```text
STM32F411                                                    
  PB6 (SCL) ●━━━━━━━━━━━━━━●━━━━━━━━━━━━━━━━━━●━━━━━━━━●
  PB7 (SDA) ●━━━━━━━━━━━━━━┃●━━━━━━━━━━━━━━━━━┃●━━━━━━━●
                           ┃┃                 ┃┃       ┃
                           ┃┃                 ┃┃       ┃
            ┌────────────┐ ┃┃  ┌────────────┐ ┃┃ ┌─────▼──────┐
            │ ATmega32   │ ┃┃  │ ATmega32   │ ┃┃ │  SSD1306   │
            │ I2C: 0x08  │ ┃┃  │ I2C: 0x07  │ ┃┃ │ I2C: 0x3C  │
            │            │ ┃┃  │            │ ┃┃ │   (OLED)   │
            │ PC0 ─────────●┃  │ PC0 ─────────●┃ └────────────┘
            │ PC1 ──────────●  │ PC1 ──────────●
            │            │     │            │
            │ PA0: Humid │     │ PA0: Humid │
            │ PA1: Temp  │     │ PA1: Temp  │
            │ PA2: Light │     │ PA2: Light │
            │            │     │            │
            │ PD2: Pump  │     │ PD2: Pump  │
            │ PD3: Fan   │     │ PD3: Fan   │
            │ PD4: Light │     │ PD4: Light │
            │ PD5: Humid │     │ PD5: Humid │
            └────────────┘     └────────────┘
                  │                  │
                  ↓                  ↓
            Environment 1      Environment 2
```
<div dir="rtl">

### چرا این مهم است:
- **مقیاس‌پذیری**: افزودن مناطق جدید با اتصال ATmega32های بیشتر به همان ۲ سیم.
- **مقرون‌به‌صرفه**: بدون نیاز به سیم‌کشی اضافی برای هر منطقه (در مقایسه با GPIO موازی).
- **آدرس‌دهی انعطاف‌پذیر**: آدرس‌دهی ۷ بیتی I2C = پشتیبانی نظری تا ۱۱۲ دستگاه.
- **کنترل متمرکز**: STM32 تمام مناطق را پایش می‌کند، پروفایل‌ها را اعمال می‌کند و در ESP32 لاگ می‌کند.

### ستاپ دمو فعلی:
- ۲ کنترلر منطقه (در عمل به راحتی قابل گسترش به ۸-۱۶ عدد).
- ۷ پروفایل گیاه (قابل افزودن در `plant_profiles.c`).
- سیستم منو که خودکار با تعداد پروفایل‌ها تنظیم می‌شود (رابط کاربری اسکرول‌دار).

---

## مقیاس‌پذیری دوگانه
| بعد | فعلی | حداکثر (عملی) | نحوه گسترش |
|---|---|---|---|
| **مناطق (Zones)** | ۲ | ۸-۱۶* | پروگرم کردن ATmega32 با آدرس جدید و اتصال به باس |
| **پروفایل‌ها** | ۷ | +۱۰۰ | افزودن ورودی به آرایه `profiles[]` |
*\* محدود شده توسط ظرفیت خازنی باس و نرخ پایش (چرخه ۵۰۰ میلی‌ثانیه)*

---

## مثال توسعه در دنیای واقعی
**سناریو**: گلخانه‌ای با ۱۰ نوع گیاه مختلف
۱. **سخت‌افزار**: افزودن ۸ عدد ATmega32 دیگر به باس I2C (آدرس‌های 0x06 تا 0x0F).
۲. **فریمور**: به‌روزرسانی `node_controller.c` با ۸ `#define` جدید.
۳. **پروفایل‌ها**: افزودن پروفایل‌های متنوع در `plant_profiles.c`.
۴. **نتیجه**: گلخانه ۱۰ منطقه‌ای با کنترل متمرکز.
**هزینه هر منطقه**: ~$3 دلار (ATmega32 + سنسورها + رله‌ها).

---

## نیازمندی‌های سخت‌افزاری
| قطعه | تعداد | توضیحات |
|---|---|---|
| STM32F411 | ۱ | کنترلر مرکزی (Master) |
| ATmega32 | +۲ | کنترلرهای منطقه (قابل افزایش) |
| ESP32 | ۱ | وب سرور |
| SSD1306 OLED | ۱ | نمایشگر I2C 128×64 |
| 4×4 Matrix Keypad | ۱ | چیپ TTP229 (SDO/SCL) |
| پتانسیومتر | ۶ | شبیه‌ساز سنسورها (۳ عدد در هر منطقه) |
| LED | ۸ | شبیه‌ساز عملگرها (4 عدد در هر منطقه) |

### اتصالات پین‌ها
**STM32F411:**
- `PB6/PB7`: رابط I2C1 (به ATmegaها و OLED)
- `PA2/PA3`: رابط USART2 (به ESP32)
- `PB8/PB9`: کیپد (SCL/SDO)

**ATmega32:**
- `PC0/PC1`: رابط I2C (TWI)
- `PA0/PA1/PA2`: ورودی‌های ADC
- `PD2/PD3/PD4/PD5`: خروجی‌های عملگر (Actuator)
*(شماتیک واقعی در پوشه `/docs` اضافه شود)*

---

##  ویدیو دمو

https://github.com/mohammadrezasafaeian/Distributed-Environmental-Control-System-DECS-/raw/refs/heads/main/docs/DECS_Pr_Demo.mp4

*برای مشاهده و دانلود ویدیو نمایش سیستم روی لینک بالا کلیک کنید*

یا مشاهده مستقیم:
![ویدیو دمو](docs/DECS_Pr_Demo.mp4)
---

## بهبودهای آینده
- [ ] **یکپارچه‌سازی DMA**: انتقال UART/I2C به DMA برای آزادسازی CPU در حین تبادل داده.
- [ ] **معماری مبتنی بر وقفه (Interrupt-Driven)**: جایگزینی سوپرلوپ (Super-loop) فعلی با مدل رویداد-محور.
- [ ] افزودن ذخیره‌سازی EEPROM برای حفظ تنظیمات
- [ ] طراحی PCB (نسخه فعلی روی برد بورد است)

---

## مجوز
MIT License - استفاده برای اهداف آموزشی/نمونه‌کار آزاد است.

---

## تماس

</div>
```
