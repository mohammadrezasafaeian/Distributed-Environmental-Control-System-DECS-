<div dir="rtl">

# سیستم کنترل هوشمند آبیاری (DECS)
*پلتفرم اتوماسیون توزیع‌شده STM32/AVR با مانیتورینگ تحت وب*

![System Demo](docs/demo-photo.jpg)

## 🎯 معرفی پروژه
یک سیستم Embedded توزیع‌شده برای اتوماسیون محیطی مقیاس‌پذیر. این پروژه اگرچه به عنوان یک **گلخانه هوشمند** پیاده‌سازی شده است، اما معماری Master-Slave آن به‌گونه‌ای طراحی شده که برای سناریوهای دیگر (مانند مانیتورینگ اتاق سرور یا انبارهای مواد غذایی) با کمترین تغییرات قابل استفاده باشد.

- **کنترل چند منطقه‌ای**: مدیریت مستقل سنسورها (دما، رطوبت، نور) و عملگرها (پمپ، فن) در هر نود.
- **باس مقیاس‌پذیر**: پشتیبانی نظری از ۱۱۲ نود تنها با استفاده از ۲ سیم (I2C).
- **طراحی مقاوم**: دارای کنترل هیسترزیس، مکانیزم بازیابی باس I2C و محافظت Watchdog.
- **رابط کاربری دوگانه**: محلی (OLED + Keypad) برای تعمیرات میدانی، و داشبورد وب (ESP32) برای مانیتورینگ از راه دور.

---

## 🕰️ روند تکامل پروژه
این پروژه یک بازطراحی (Re-engineering) کامل از اولین تلاش من در دنیای امبدد در سال ۲۰۲۰ است.
> [👉 **مشاهده کد اولیه و قدیمی (نسخه ۲۰۲۰)**](legacy_2020_v0/)

من مجدداً به سراغ این ایده قدیمی رفتم تا نشان دهم چگونه می‌توانم استانداردهای حرفه‌ای (مانند معماری توزیع‌شده و I/O غیرمسدودکننده) را جایگزین روش‌های مقدماتی گذشته کنم.

---

## 🏗️ معماری سیستم
</div>

```text
┌─────────────────────────────────────────────────────────┐
│                    STM32F4 Master                       │
│  - Profile database & control logic                     │
│  - I2C master (polls zone controllers)                  │
│  - OLED/Keypad UI                                       │
│  - UART → ESP32                                         │
└───────────┬──────────────┬──────────────┬───────────────┘
            │ I2C          │ I2C          │ UART
    ┌───────▼──────┐  ┌────▼──────┐  ┌───▼──────────┐
    │  ATmega32    │  │ ATmega32  │  │   ESP32      │
    │  Zone 1      │  │  Zone 2   │  │  WiFi AP     │
    │ (0x08)       │  │  (0x07)   │  │  Dashboard   │
    │              │  │           │  │  Port 80     │
    │ 3× Sensors   │  │ 3× Sensors│  └──────────────┘
    │ 4× Actuators │  │ 4× Actuators│
    └──────────────┘  └────────────┘
```

<div dir="rtl">

### تصمیمات کلیدی طراحی
۱. **هوش متمرکز (STM32)**: منطق تصمیم‌گیری و پروفایل‌ها فقط در Master قرار دارند. نودهای توزیع‌شده به عنوان توسعه‌دهنده‌های I/O "ساده" طراحی شده‌اند که باعث می‌شود ارزان‌تر باشند و تعویض آن‌ها در محیط‌های سخت آسان‌تر باشد.
۲. **ورودی/خروجی توزیع‌شده (AVR)**: نودهای ATmega32 کارهای سطح پایین (ارتباط با سنسورهای 5V، سوئیچینگ رله) را انجام می‌دهند و Master 3.3V را از نویز الکتریکی ایزوله می‌کنند.
۳. **کنترل هیسترزیس**: پیاده‌سازی بافر ±۵۰ واحد ADC برای جلوگیری از روشن/خاموش شدن سریع پمپ‌ها و فن‌ها (chattering) در نزدیکی مقادیر آستانه.

---

## 📡 پروتکل‌های ارتباطی
| باس | جهت | فرمت | نرخ |
|---|---|---|---|
| **I2C** | STM32 → ATmega32 | دستورات (0x10-0x17) | 500ms |
| **I2C** | ATmega32 → STM32 | ۶ بایت (۳ مقدار ۱۶ بیتی ADC) | 500ms |
| **UART** | STM32 → ESP32 | وضعیت JSON | 1000ms |
| **SPI** | STM32 → SSD1306 | به‌روزرسانی نمایشگر | 250ms |

---

## 🌱 پایگاه داده پروفایل گیاهان
در حال حاضر ۷ پروفایل پشتیبانی می‌شود (قابل توسعه در `plant_profiles.c`):
| پروفایل | رطوبت | دما | نور | فاصله | مدت |
|---|---|---|---|---|---|
| گوجه | 450 | 280 | 650 | ۳۰ثانیه | ۵ثانیه |
| کاهو | 500 | 200 | 400 | ۲۰ثانیه | ۳ثانیه |
| خیار | 490 | 270 | 620 | ۳۵ثانیه | ۶ثانیه |

**افزودن پروفایل**: کافیست به آرایه `profiles[]` اضافه کنید.

---

## 🎮 قابلیت‌ها
### کنترلر مرکزی STM32 (STM32F411)
- ✅ سیستم منو با اسکرول (پشتیبانی از ۴+ پروفایل در هر صفحه)
- ✅ حالت کنترل دستی (کنترل مستقیم عملگرها)
- ✅ کنترل خودکار با هیسترزیس
- ✅ بازیابی باس I2C (مدیریت slave های گیر کرده)
- ✅ تشخیص corruption حافظه (stack canary)

### کنترلر منطقه (ATmega32 @ 8MHz)
- ✅ ۳ خواندن ADC ده-بیتی (رطوبت/دما/نور)
- ✅ ۴ عملگر GPIO (پمپ/رطوبت‌ساز/فن/نور)
- ✅ حالت slave در I2C با پردازش دستورات
- ✅ نمونه‌برداری بیشتر (Oversampling - ۱۰۰ نمونه در هر خواندن)

### داشبورد وب ESP32
- ✅ نمودارهای real-time سنسورها (Chart.js)
- ✅ نشانگرهای وضعیت live عملگرها
- ✅ نقشه حرارتی آبیاری ۲۴ ساعته
- ✅ لاگ رویدادها (Timeline)
- ✅ طراحی ریسپانسیو (Responsive)

---

### مقیاس‌پذیری سیستم
به کمک پروتکل ارتباطی I2C، سیستم تنها از دو سیم به‌عنوان باس اشتراکی برای ارتباط با تمامی نودها استفاده می‌کند.

</div>

```text
STM32F411                                                    
  PB6 (SCL) ●━━━━━━━━━━━━━━●━━━━━━━━━━━━━━━━━━●━━━━━━━━●
  PB7 (SDA) ●━━━━━━━━━━━━━━┃●━━━━━━━━━━━━━━━━━┃●━━━━━━━●
                           ┃┃                 ┃┃       ┃
                           ┃┃                 ┃┃       ┃
            ┌────────────┐ ┃┃  ┌────────────┐ ┃┃ ┌─────▼──────┐
            │ ATmega32   │ ┃┃  │ ATmega32   │ ┃┃ │  SSD1306   │
            │ I2C: 0x08  │ ┃┃  │ I2C: 0x07  │ ┃┃ │ I2C: 0x3C  │
            │            │ ┃┃  │            │ ┃┃ │   (OLED)   │
            │ PC0 ─────────●┃  │ PC0 ─────────●┃ └────────────┘
            │ PC1 ──────────●  │ PC1 ──────────●
            │            │     │            │
            │ PA0: Humid │     │ PA0: Humid │
            │ PA1: Temp  │     │ PA1: Temp  │
            │ PA2: Light │     │ PA2: Light │
            │            │     │            │
            │ PD2: Pump  │     │ PD2: Pump  │
            │ PD3: Fan   │     │ PD3: Fan   │
            │ PD4: Light │     │ PD4: Light │
            │ PD5: Humid │     │ PD5: Humid │
            └────────────┘     └────────────┘
                  │                  │
                  ↓                  ↓
            Environment 1      Environment 2
```

<div dir="rtl">

## 🔮 بهبودهای آینده
- [ ] افزودن ذخیره‌سازی EEPROM برای حفظ تنظیمات پس از خاموشی
- [ ] پیاده‌سازی کنترل دوطرفه ESP32 ↔ STM32 (دریافت فرمان از وب)
- [ ] افزودن پشتیبانی از سنسور رطوبت خاک (آنالوگ یا I2C)
- [ ] پورت کردن سیستم به FreeRTOS برای مدیریت بهتر وظایف
- [ ] طراحی PCB صنعتی (نسخه فعلی روی برد بورد است)

---

## 📧 تماس
**[نام شما]**
<br>
📧 your.email@example.com
<br>
🔗 [پروفایل لینکدین]
<br>
💼 در جستجوی موقعیت‌های شغلی Embedded Systems

</div>
```
